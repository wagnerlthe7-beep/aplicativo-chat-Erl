import 'package:flutter/material.dart';
import 'package:flutter_contacts/flutter_contacts.dart';
import 'package:permission_handler/permission_handler.dart';
import 'auth_service.dart';
import 'chat_page.dart'; // <-- ADICIONE ESTE IMPORT PARA ABRIR TELA DE CHAT
import 'dart:async';
import 'contacts_helper.dart';

class ChatListPage extends StatefulWidget {
  @override
  _ChatListPageState createState() => _ChatListPageState();
}

class _ChatListPageState extends State<ChatListPage>
    with TickerProviderStateMixin {
  bool _isLoading = false;
  Timer? _sessionTimer;
  late TabController _tabController;
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _startSessionValidationTimer();
  }

  @override
  void dispose() {
    _sessionTimer?.cancel();
    _tabController.dispose();
    _searchController.dispose();
    super.dispose();
  }

  void _startSessionValidationTimer() {
    _sessionTimer = Timer.periodic(Duration(seconds: 10), (timer) async {
      final isValid = await AuthService.validateCurrentSession();
      if (!isValid && mounted) {
        timer.cancel();
        _showSessionExpiredDialog();
      }
    });
  }

  void _showSessionExpiredDialog() {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        title: Text('Sessão Expirada'),
        content: Text(
          'Sua sessão foi encerrada em outro dispositivo. Você será redirecionado para o login.',
        ),
        actions: [
          TextButton(
            onPressed: () {
              _redirectToLogin();
            },
            child: Text('OK'),
          ),
        ],
      ),
    );
  }

  void _redirectToLogin() async {
    await AuthService.clearLocalSession();
    Navigator.pushNamedAndRemoveUntil(context, '/welcome', (route) => false);
  }

  // NOVA FUNÇÃO: Abrir lista de contatos
  Future<void> _openContactsList() async {
    // Verificar permissão
    final contactPermission = await Permission.contacts.status;

    if (!contactPermission.isGranted) {
      final result = await Permission.contacts.request();
      if (!result.isGranted) {
        _showPermissionDeniedDialog();
        return;
      }
    }

    setState(() => _isLoading = true);
    try {
      final contacts = await FlutterContacts.getContacts(
        withProperties: true,
        withPhoto: true,
      );

      _showContactsSelectionDialog(contacts);
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Erro ao carregar contatos: $e')));
    } finally {
      setState(() => _isLoading = false);
    }
  }

  // NOVA FUNÇÃO: Mostrar diálogo com contatos
  // NOVA FUNÇÃO: Mostrar diálogo com contatos E PESQUISA
  // NOVA FUNÇÃO: Mostrar diálogo com contatos E PESQUISA EXPANSÍVEL PARA ESQUERDA
  void _showContactsSelectionDialog(List<Contact> contacts) {
    final searchController = TextEditingController();
    List<Contact> filteredContacts = List.from(contacts);
    bool _isSearching = false;

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) {
          void filterContacts(String query) {
            setState(() {
              if (query.isEmpty) {
                filteredContacts = List.from(contacts);
              } else {
                filteredContacts = contacts.where((contact) {
                  final name = contact.displayName.toLowerCase();
                  final phones = contact.phones
                      .map((phone) => phone.number)
                      .join(' ');
                  final searchLower = query.toLowerCase();

                  return name.contains(searchLower) ||
                      phones.contains(searchLower) ||
                      phones
                          .replaceAll(RegExp(r'[\s\-\(\)]'), '')
                          .contains(searchLower);
                }).toList();
              }
            });
          }

          void _toggleSearch() {
            setState(() {
              _isSearching = !_isSearching;
              if (!_isSearching) {
                searchController.clear();
                filterContacts('');
              }
            });
          }

          return AlertDialog(
            title: Container(
              height: 40, // ALTURA FIXA PARA EVITAR EXPANSÃO
              child: Row(
                mainAxisAlignment:
                    MainAxisAlignment.spaceBetween, // DISTRIBUI ESPAÇO
                children: [
                  // LADO ESQUERDO: Ícone + Texto
                  Row(
                    children: [
                      Icon(Icons.contacts, color: Colors.green, size: 20),
                      SizedBox(width: 6),
                      if (!_isSearching)
                        Text(
                          'Selecionar Contacto',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                    ],
                  ),

                  // LADO DIREITO: Campo de pesquisa + X OU Botão de pesquisa
                  if (_isSearching)
                    Expanded(
                      child: Row(
                        children: [
                          Expanded(
                            child: Padding(
                              padding: EdgeInsets.only(
                                left: 16,
                              ), // ESPAÇO DO LADO ESQUERDO
                              child: TextField(
                                controller: searchController,
                                autofocus: true,
                                onChanged: filterContacts,
                                decoration: InputDecoration(
                                  hintText: 'Pesquisar...',
                                  hintStyle: TextStyle(
                                    color: Colors.grey[600],
                                    fontSize: 14,
                                  ),
                                  border: InputBorder.none,
                                  contentPadding: EdgeInsets.zero,
                                ),
                                style: TextStyle(fontSize: 14),
                              ),
                            ),
                          ),
                          // BOTÃO X PARA FECHAR PESQUISA
                          IconButton(
                            icon: Icon(
                              Icons.close,
                              color: Colors.green,
                              size: 20,
                            ),
                            padding: EdgeInsets.all(4),
                            constraints: BoxConstraints(
                              minWidth: 36,
                              minHeight: 36,
                            ),
                            onPressed: _toggleSearch,
                          ),
                        ],
                      ),
                    )
                  else
                    IconButton(
                      icon: Icon(Icons.search, color: Colors.green, size: 20),
                      padding: EdgeInsets.all(4),
                      constraints: BoxConstraints(minWidth: 36, minHeight: 36),
                      onPressed: _toggleSearch,
                    ),
                ],
              ),
            ),
            content: Container(
              width: double.maxFinite,
              height: MediaQuery.of(context).size.height * 0.6,
              child: Column(
                children: [
                  // CONTADOR DE CONTACTOS
                  if (!_isSearching) SizedBox(height: 8),
                  Row(
                    children: [
                      Text(
                        '${filteredContacts.length} contactos encontrados',
                        style: TextStyle(color: Colors.grey[600], fontSize: 12),
                      ),
                    ],
                  ),
                  SizedBox(height: 12),

                  // LISTA DE CONTACTOS
                  Expanded(
                    child: filteredContacts.isEmpty
                        ? Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  _isSearching &&
                                          searchController.text.isNotEmpty
                                      ? Icons.search_off
                                      : Icons.contacts_outlined,
                                  size: 60,
                                  color: Colors.grey,
                                ),
                                SizedBox(height: 16),
                                Text(
                                  _isSearching &&
                                          searchController.text.isNotEmpty
                                      ? 'Nenhum resultado para "${searchController.text}"'
                                      : 'Nenhum contacto encontrado',
                                  style: TextStyle(color: Colors.grey),
                                  textAlign: TextAlign.center,
                                ),
                              ],
                            ),
                          )
                        : ListView.builder(
                            itemCount: filteredContacts.length,
                            itemBuilder: (context, index) {
                              final contact = filteredContacts[index];
                              return _buildContactItem(contact);
                            },
                          ),
                  ),
                ],
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: Text('Voltar'),
              ),
            ],
          );
        },
      ),
    );
  }

  // NOVA FUNÇÃO: Item da lista de contatos
  Widget _buildContactItem(Contact contact) {
    final displayName = contact.displayName.isEmpty
        ? 'Sem nome'
        : contact.displayName;
    final phones = contact.phones.isNotEmpty
        ? contact.phones.first.number
        : 'Sem telefone';

    return Container(
      decoration: BoxDecoration(
        border: Border(bottom: BorderSide(color: Colors.grey[200]!)),
      ),
      child: ListTile(
        leading: contact.photo != null
            ? CircleAvatar(
                radius: 22,
                backgroundImage: MemoryImage(contact.photo!),
              )
            : CircleAvatar(
                radius: 22,
                backgroundColor: Colors.green[100],
                child: Icon(Icons.person, color: Colors.green, size: 24),
              ),
        title: Text(
          displayName,
          style: TextStyle(fontWeight: FontWeight.w500, fontSize: 16),
        ),
        subtitle: Text(
          phones,
          style: TextStyle(color: Colors.grey[600], fontSize: 14),
        ),
        trailing: Icon(Icons.chat, color: Colors.green),
        onTap: () {
          Navigator.pop(context);
          _startNewChat(contact);
        },
      ),
    );
  }

  // NOVA FUNÇÃO: Iniciar novo chat
  Future<void> _startNewChat(Contact contact) async {
    setState(() => _isLoading = true);
    try {
      final remoteUserId = await ContactsHelper.fetchBackendUserId(contact);
      if (!mounted) return;

      if (remoteUserId == null) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Este contato ainda não está registrado no SpeekJoy.',
            ),
          ),
        );
        return;
      }

      // Navegar para a tela de chat
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) =>
              ChatPage(contact: contact, remoteUserId: remoteUserId),
        ),
      );
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Erro ao iniciar conversa: $e')));
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // NOVA FUNÇÃO: Diálogo de permissão negada
  void _showPermissionDeniedDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Permissão Necessária'),
        content: Text(
          'Para selecionar contatos, é necessário permitir o acesso à lista de contatos.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancelar'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              openAppSettings();
            },
            child: Text('Configurações'),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.green),
          ),
        ],
      ),
    );
  }

  Future<void> _logout() async {
    setState(() => _isLoading = true);
    try {
      await AuthService.logout();
      Navigator.pushNamedAndRemoveUntil(context, '/welcome', (route) => false);
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Erro ao fazer logout: $e')));
    } finally {
      setState(() => _isLoading = false);
    }
  }

  Future<void> _revokeOtherSessions() async {
    setState(() => _isLoading = true);
    try {
      final success = await AuthService.revokeOtherSessions();
      if (success) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('✅ Outras sessões foram revogadas com sucesso!'),
            backgroundColor: Colors.green,
          ),
        );
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('❌ Erro ao revogar outras sessões'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Erro: $e')));
    } finally {
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.green,
        elevation: 0,
        title: Text(
          'SpeekJoy',
          style: TextStyle(
            color: Colors.white,
            fontSize: 20,
            fontWeight: FontWeight.w500,
          ),
        ),
        actions: [
          IconButton(
            icon: Icon(Icons.camera_alt, color: Colors.white),
            onPressed: () {},
          ),
          IconButton(
            icon: Icon(Icons.search, color: Colors.white),
            onPressed: () {},
          ),
          PopupMenuButton<String>(
            icon: Icon(Icons.more_vert, color: Colors.white),
            onSelected: (value) {
              if (value == 'logout')
                _logout();
              else if (value == 'revoke_others')
                _showRevokeDialog();
            },
            itemBuilder: (context) => [
              PopupMenuItem(
                value: 'revoke_others',
                child: Row(
                  children: [
                    Icon(Icons.security, color: Colors.orange),
                    SizedBox(width: 8),
                    Text('Sair de outros dispositivos'),
                  ],
                ),
              ),
              PopupMenuItem(
                value: 'logout',
                child: Row(
                  children: [
                    Icon(Icons.logout, color: Colors.red),
                    SizedBox(width: 8),
                    Text('Logout'),
                  ],
                ),
              ),
            ],
          ),
        ],
        bottom: PreferredSize(
          preferredSize: Size.fromHeight(70),
          child: Container(
            color: Colors.white,
            child: Column(
              children: [
                Container(height: 1, color: Colors.grey[300]),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 8, vertical: 12),
                  child: TabBar(
                    controller: _tabController,
                    indicatorColor: Colors.green,
                    labelColor: Colors.green,
                    unselectedLabelColor: Colors.grey[600],
                    tabs: [
                      Tab(
                        child: Column(
                          children: [
                            Icon(Icons.chat_bubble_outline, size: 18),
                            SizedBox(height: 2),
                            Text('CHATS', style: TextStyle(fontSize: 10)),
                          ],
                        ),
                      ),
                      Tab(
                        child: Column(
                          children: [
                            Icon(Icons.radio_button_checked, size: 18),
                            SizedBox(height: 2),
                            Text('STATUS', style: TextStyle(fontSize: 10)),
                          ],
                        ),
                      ),
                      Tab(
                        child: Column(
                          children: [
                            Icon(Icons.call, size: 18),
                            SizedBox(height: 2),
                            Text('CALLS', style: TextStyle(fontSize: 10)),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
      body: Column(
        children: [
          Container(
            color: Colors.white,
            padding: EdgeInsets.all(16),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.grey[100],
                borderRadius: BorderRadius.circular(20),
              ),
              child: TextField(
                controller: _searchController,
                onChanged: (value) => setState(() => _searchQuery = value),
                decoration: InputDecoration(
                  hintText: 'Pesquisar ou começar nova conversa',
                  hintStyle: TextStyle(color: Colors.grey[600]),
                  prefixIcon: Icon(Icons.search, color: Colors.grey[600]),
                  border: InputBorder.none,
                  contentPadding: EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: 12,
                  ),
                ),
              ),
            ),
          ),
          Expanded(
            child: TabBarView(
              controller: _tabController,
              children: [_buildChatsTab(), _buildStatusTab(), _buildCallsTab()],
            ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _openContactsList, // AGORA ABRE A LISTA DE CONTATOS
        backgroundColor: Colors.green,
        child: _isLoading
            ? SizedBox(
                width: 20,
                height: 20,
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                ),
              )
            : Icon(Icons.chat, color: Colors.white),
      ),
    );
  }

  Widget _buildChatsTab() {
    return ListView.builder(
      padding: EdgeInsets.only(top: 8),
      itemCount: _getChatsList().length,
      itemBuilder: (context, index) => _buildChatItem(_getChatsList()[index]),
    );
  }

  Widget _buildStatusTab() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.radio_button_checked, size: 80, color: Colors.grey[400]),
          SizedBox(height: 20),
          Text(
            'Status em breve',
            style: TextStyle(fontSize: 18, color: Colors.grey[600]),
          ),
          SizedBox(height: 10),
          Text(
            'Esta funcionalidade será implementada em breve',
            style: TextStyle(fontSize: 14, color: Colors.grey[500]),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildCallsTab() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.call, size: 80, color: Colors.grey[400]),
          SizedBox(height: 20),
          Text(
            'Chamadas em breve',
            style: TextStyle(fontSize: 18, color: Colors.grey[600]),
          ),
          SizedBox(height: 10),
          Text(
            'Esta funcionalidade será implementada em breve',
            style: TextStyle(fontSize: 14, color: Colors.grey[500]),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildChatItem(Map<String, dynamic> chat) {
    return Container(
      decoration: BoxDecoration(
        border: Border(
          bottom: BorderSide(color: Colors.grey[200]!, width: 0.5),
        ),
      ),
      child: ListTile(
        leading: CircleAvatar(
          radius: 25,
          backgroundColor: Colors.grey[300],
          child: chat['avatar'] != null
              ? ClipOval(child: chat['avatar'])
              : Icon(Icons.person, color: Colors.grey[600], size: 28),
        ),
        title: Text(
          chat['name'],
          style: TextStyle(fontWeight: FontWeight.w500, fontSize: 16),
        ),
        subtitle: Text(
          chat['lastMessage'],
          style: TextStyle(color: Colors.grey[600], fontSize: 14),
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
        trailing: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Text(
              chat['time'],
              style: TextStyle(color: Colors.grey[500], fontSize: 12),
            ),
            if (chat['unreadCount'] > 0)
              Container(
                margin: EdgeInsets.only(top: 4),
                padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: Colors.green,
                  borderRadius: BorderRadius.circular(10),
                ),
                child: Text(
                  chat['unreadCount'].toString(),
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
          ],
        ),
        onTap: () {},
      ),
    );
  }

  List<Map<String, dynamic>> _getChatsList() {
    return [
      {
        'name': 'João Silva',
        'lastMessage': 'Oi, como você está?',
        'time': '14:30',
        'unreadCount': 2,
        'avatar': null,
      },
      {
        'name': 'Maria Santos',
        'lastMessage': 'Vamos sair hoje?',
        'time': '13:45',
        'unreadCount': 0,
        'avatar': null,
      },
      {
        'name': 'Pedro Costa',
        'lastMessage': 'Obrigado pela ajuda!',
        'time': '12:20',
        'unreadCount': 1,
        'avatar': null,
      },
      {
        'name': 'Ana Oliveira',
        'lastMessage': 'Tchau!',
        'time': 'Ontem',
        'unreadCount': 0,
        'avatar': null,
      },
    ].where((chat) {
      if (_searchQuery.isEmpty) return true;
      return (chat['name'] as String).toLowerCase().contains(
            _searchQuery.toLowerCase(),
          ) ||
          (chat['lastMessage'] as String).toLowerCase().contains(
            _searchQuery.toLowerCase(),
          );
    }).toList();
  }

  void _showRevokeDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Sair de outros dispositivos'),
        content: Text(
          'Isso irá desconectar todos os outros dispositivos que estão usando sua conta. Você permanecerá conectado neste dispositivo. Deseja continuar?',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancelar'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              _revokeOtherSessions();
            },
            child: Text('Confirmar'),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.orange,
              foregroundColor: Colors.white,
            ),
          ),
        ],
      ),
    );
  }
}
